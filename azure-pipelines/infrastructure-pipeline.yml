trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infrastructure/bicep/*
      - azure-pipelines/infrastructure-pipeline.yml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - infrastructure/bicep/*

parameters:
  - name: environment
    displayName: "Environment"
    type: string
    default: "dev"
    values:
      - dev
      - staging
      - prod
  - name: action
    displayName: "Action"
    type: string
    default: "deploy"
    values:
      - deploy
      - destroy

variables:
  - name: azureServiceConnection
    value: "ARM_SERVICE_CONNECTION"
  - name: location
    value: "eastus"
  - name: resourceGroupPrefix
    value: "rg-ecommerce-aks"
  - name: resourceGroup
    value: "$(resourceGroupPrefix)-${{ parameters.environment }}"
  - name: deploymentName
    value: "aks-infra-$(Build.BuildNumber)"

stages:
  - stage: Validate
    displayName: "Validate Infrastructure"
    jobs:
      - job: ValidateBicep
        displayName: "Validate Bicep Template"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: AzureCLI@2
            displayName: "Azure CLI - Validate Template"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # Generate SSH key
                mkdir -p ~/.ssh
                ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa_aks -N "" -C "aks-ecommerce-azdo"
                SSH_PUBLIC_KEY=$(cat ~/.ssh/id_rsa_aks.pub)

                cd infrastructure/bicep

                # Update parameters with SSH key
                jq --arg ssh_key "$SSH_PUBLIC_KEY" \
                   '.parameters.sshPublicKey.value = $ssh_key' \
                   parameters.${{ parameters.environment }}.json > parameters.tmp.json

                # Create resource group
                az group create \
                  --name $(resourceGroup) \
                  --location $(location)

                # Validate deployment
                az deployment group validate \
                  --resource-group $(resourceGroup) \
                  --template-file main.bicep \
                  --parameters @parameters.tmp.json

                echo "✅ Validation successful"

  - stage: Deploy
    displayName: "Deploy Infrastructure"
    dependsOn: Validate
    condition: and(succeeded(), eq('${{ parameters.action }}', 'deploy'))
    jobs:
      - deployment: DeployInfrastructure
        displayName: "Deploy AKS Infrastructure"
        environment: ${{ parameters.environment }}
        pool:
          vmImage: "ubuntu-latest"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: "Deploy Bicep Template"
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      # Generate SSH key
                      mkdir -p ~/.ssh
                      ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa_aks -N "" -C "aks-ecommerce-azdo"
                      SSH_PUBLIC_KEY=$(cat ~/.ssh/id_rsa_aks.pub)

                      cd infrastructure/bicep

                      # Update parameters
                      jq --arg ssh_key "$SSH_PUBLIC_KEY" \
                         '.parameters.sshPublicKey.value = $ssh_key' \
                         parameters.${{ parameters.environment }}.json > parameters.tmp.json

                      # Deploy infrastructure
                      az deployment group create \
                        --resource-group $(resourceGroup) \
                        --name $(deploymentName) \
                        --template-file main.bicep \
                        --parameters @parameters.tmp.json \
                        --output table

                      echo "✅ Deployment successful"

                - task: AzureCLI@2
                  displayName: "Get Deployment Outputs"
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      # Get outputs
                      AKS_NAME=$(az deployment group show \
                        --resource-group $(resourceGroup) \
                        --name $(deploymentName) \
                        --query 'properties.outputs.aksClusterName.value' \
                        --output tsv)

                      ACR_NAME=$(az deployment group show \
                        --resource-group $(resourceGroup) \
                        --name $(deploymentName) \
                        --query 'properties.outputs.acrName.value' \
                        --output tsv)

                      ACR_LOGIN_SERVER=$(az deployment group show \
                        --resource-group $(resourceGroup) \
                        --name $(deploymentName) \
                        --query 'properties.outputs.acrLoginServer.value' \
                        --output tsv)

                      # Set pipeline variables
                      echo "##vso[task.setvariable variable=aksClusterName;isOutput=true]$AKS_NAME"
                      echo "##vso[task.setvariable variable=acrName;isOutput=true]$ACR_NAME"
                      echo "##vso[task.setvariable variable=acrLoginServer;isOutput=true]$ACR_LOGIN_SERVER"

                      echo "AKS Cluster: $AKS_NAME"
                      echo "ACR Name: $ACR_NAME"
                      echo "ACR Login Server: $ACR_LOGIN_SERVER"

                - task: AzureCLI@2
                  displayName: "Verify Cluster"
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      # Get AKS credentials
                      az aks get-credentials \
                        --resource-group $(resourceGroup) \
                        --name $(aksClusterName) \
                        --overwrite-existing

                      # Verify cluster
                      kubectl cluster-info
                      kubectl get nodes

                      echo "✅ Cluster verified"

  - stage: Destroy
    displayName: "Destroy Infrastructure"
    dependsOn: Validate
    condition: and(succeeded(), eq('${{ parameters.action }}', 'destroy'))
    jobs:
      - job: ConfirmDestroy
        displayName: "Confirm Destruction"
        pool: server
        steps:
          - task: ManualValidation@0
            displayName: "Manual Approval Required"
            inputs:
              notifyUsers: ""
              instructions: "This will DELETE all infrastructure in $(resourceGroup). Are you sure?"

      - deployment: DestroyInfrastructure
        displayName: "Delete Resource Group"
        dependsOn: ConfirmDestroy
        environment: ${{ parameters.environment }}
        pool:
          vmImage: "ubuntu-latest"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: "Delete Resource Group"
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      echo "Deleting resource group: $(resourceGroup)"
                      az group delete \
                        --name $(resourceGroup) \
                        --yes \
                        --no-wait

                      echo "✅ Deletion initiated"
