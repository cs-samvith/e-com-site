trigger:
  branches:
    include:
      - main
  paths:
    include:
      - services/*

pr:
  branches:
    include:
      - main
  paths:
    include:
      - services/*

parameters:
  - name: environment
    displayName: "Environment"
    type: string
    default: "dev"
    values:
      - dev
      - staging
      - prod
  - name: services
    displayName: "Services to Build"
    type: object
    default:
      - product-service
      - user-service
      - frontend-service

variables:
  - name: azureServiceConnection
    value: "azure-ecommerce-sp"
  - name: resourceGroupPrefix
    value: "rg-ecommerce-aks"
  - name: resourceGroup
    value: "$(resourceGroupPrefix)-${{ parameters.environment }}"
  - name: imageTag
    value: "$(Build.BuildNumber)"

stages:
  - stage: Build
    displayName: "Build Docker Images"
    jobs:
      - ${{ each service in parameters.services }}:
          - job: Build_${{ replace(service, '-', '_') }}
            displayName: "Build ${{ service }}"
            pool:
              vmImage: "ubuntu-latest"
            steps:
              - checkout: self

              - task: AzureCLI@2
                displayName: "Get ACR Info"
                name: GetACR
                inputs:
                  azureSubscription: $(azureServiceConnection)
                  scriptType: "bash"
                  scriptLocation: "inlineScript"
                  inlineScript: |
                    ACR_NAME=$(az acr list \
                      --resource-group $(resourceGroup) \
                      --query "[0].name" \
                      --output tsv)

                    if [ -z "$ACR_NAME" ]; then
                      echo "##vso[task.logissue type=error]ACR not found in $(resourceGroup)"
                      echo "Please run the Infrastructure pipeline first"
                      exit 1
                    fi

                    echo "##vso[task.setvariable variable=acrName;isOutput=true]$ACR_NAME"
                    echo "ACR Name: $ACR_NAME"

              - task: AzureCLI@2
                displayName: "Build and Push ${{ service }}"
                inputs:
                  azureSubscription: $(azureServiceConnection)
                  scriptType: "bash"
                  scriptLocation: "inlineScript"
                  inlineScript: |
                    ACR_NAME=$(az acr list \
                      --resource-group $(resourceGroup) \
                      --query "[0].name" \
                      --output tsv)

                    SERVICE="${{ service }}"
                    IMAGE_TAG="$(imageTag)"

                    echo "Building $SERVICE in ACR: $ACR_NAME"
                    echo "Image tags: $IMAGE_TAG, latest"

                    # Build in Azure Container Registry (no Docker daemon needed)
                    az acr build \
                      --registry $ACR_NAME \
                      --image $SERVICE:$IMAGE_TAG \
                      --image $SERVICE:latest \
                      --file services/$SERVICE/Dockerfile \
                      services/$SERVICE

                    echo "✅ $SERVICE built and pushed successfully"

              - task: AzureCLI@2
                displayName: "Verify Image ${{ service }}"
                inputs:
                  azureSubscription: $(azureServiceConnection)
                  scriptType: "bash"
                  scriptLocation: "inlineScript"
                  inlineScript: |
                    ACR_NAME=$(az acr list \
                      --resource-group $(resourceGroup) \
                      --query "[0].name" \
                      --output tsv)

                    echo "Listing tags for ${{ service }}:"
                    az acr repository show-tags \
                      --name $ACR_NAME \
                      --repository ${{ service }} \
                      --output table

                    echo "✅ Image ${{ service }}:$(imageTag) verified"

  - stage: Publish
    displayName: "Publish Build Info"
    dependsOn: Build
    jobs:
      - job: PublishArtifacts
        displayName: "Publish Build Artifacts"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: PublishBuildArtifacts@1
            displayName: "Publish Kubernetes Manifests"
            inputs:
              PathtoPublish: "kubernetes"
              ArtifactName: "kubernetes-manifests"
              publishLocation: "Container"

          - bash: |
              mkdir -p $(Build.ArtifactStagingDirectory)

              cat > $(Build.ArtifactStagingDirectory)/build-info.txt <<EOF
              Build Number: $(Build.BuildNumber)
              Image Tag: $(imageTag)
              Environment: ${{ parameters.environment }}
              Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              Source Branch: $(Build.SourceBranch)
              Commit: $(Build.SourceVersion)
              EOF

              echo "Build info saved"
              cat $(Build.ArtifactStagingDirectory)/build-info.txt
            displayName: "Create Build Info"

          - task: PublishBuildArtifacts@1
            displayName: "Publish Build Info"
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)"
              ArtifactName: "drop"
              publishLocation: "Container"

  - stage: Summary
    displayName: "Build Summary"
    dependsOn: Build
    jobs:
      - job: DisplaySummary
        displayName: "Display Build Summary"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: AzureCLI@2
            displayName: "List All Built Images"
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                ACR_NAME=$(az acr list \
                  --resource-group $(resourceGroup) \
                  --query "[0].name" \
                  --output tsv)

                echo "========================================="
                echo "Build Summary"
                echo "========================================="
                echo "ACR: $ACR_NAME"
                echo "Image Tag: $(imageTag)"
                echo ""

                for repo in product-service user-service frontend-service; do
                  echo "=== $repo ==="
                  az acr repository show-tags \
                    --name $ACR_NAME \
                    --repository $repo \
                    --output table 2>/dev/null || echo "No images found"
                  echo ""
                done

                echo "========================================="
                echo "✅ All images built successfully!"
                echo "========================================="
                echo ""
                echo "Next step: Run 'Deploy to AKS' pipeline"
