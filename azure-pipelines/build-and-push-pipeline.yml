trigger:
  branches:
    include:
      - main
  paths:
    include:
      - services/*

pr:
  branches:
    include:
      - main
  paths:
    include:
      - services/*

parameters:
  - name: environment
    displayName: "Environment"
    type: string
    default: "dev"
    values:
      - dev
      - staging
      - prod
  - name: services
    displayName: "Services to Build"
    type: object
    default:
      - product-service
      - user-service
      - frontend-service

variables:
  - name: azureServiceConnection
    value: "azure-ecommerce-sp"
  - name: resourceGroupPrefix
    value: "rg-ecommerce-aks"
  - name: resourceGroup
    value: "$(resourceGroupPrefix)-${{ parameters.environment }}"
  - name: imageTag
    value: "$(Build.BuildNumber)"
  - name: dockerRegistryServiceConnection
    value: "acr-ecommerce"

stages:
  - stage: Build
    displayName: "Build Docker Images"
    jobs:
      - ${{ each service in parameters.services }}:
          - job: Build_${{ replace(service, '-', '_') }}
            displayName: "Build ${{ service }}"
            pool:
              vmImage: "ubuntu-latest"
            steps:
              - task: Docker@2
                displayName: "Login to ACR"
                inputs:
                  containerRegistry: $(dockerRegistryServiceConnection)
                  command: "login"

              - task: AzureCLI@2
                displayName: "Get ACR Info"
                inputs:
                  azureSubscription: $(azureServiceConnection)
                  scriptType: "bash"
                  scriptLocation: "inlineScript"
                  inlineScript: |
                    ACR_NAME=$(az acr list \
                      --resource-group $(resourceGroup) \
                      --query "[0].name" \
                      --output tsv)

                    ACR_LOGIN_SERVER=$(az acr show \
                      --name $ACR_NAME \
                      --query loginServer \
                      --output tsv)

                    echo "##vso[task.setvariable variable=acrLoginServer]$ACR_LOGIN_SERVER"
                    echo "ACR Login Server: $ACR_LOGIN_SERVER"

              - task: Docker@2
                displayName: "Build Image"
                inputs:
                  containerRegistry: $(dockerRegistryServiceConnection)
                  repository: "${{ service }}"
                  command: "build"
                  Dockerfile: "services/${{ service }}/Dockerfile"
                  tags: |
                    $(imageTag)
                    latest
                  arguments: '--build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")'

              - task: Docker@2
                displayName: "Push Image with Tag"
                inputs:
                  containerRegistry: $(dockerRegistryServiceConnection)
                  repository: "${{ service }}"
                  command: "push"
                  tags: "$(imageTag)"

              - task: Docker@2
                displayName: "Push Image as Latest"
                inputs:
                  containerRegistry: $(dockerRegistryServiceConnection)
                  repository: "${{ service }}"
                  command: "push"
                  tags: "latest"

              - task: AzureCLI@2
                displayName: "Verify Image"
                inputs:
                  azureSubscription: $(azureServiceConnection)
                  scriptType: "bash"
                  scriptLocation: "inlineScript"
                  inlineScript: |
                    ACR_NAME=$(az acr list \
                      --resource-group $(resourceGroup) \
                      --query "[0].name" \
                      --output tsv)

                    echo "Listing tags for ${{ service }}:"
                    az acr repository show-tags \
                      --name $ACR_NAME \
                      --repository ${{ service }} \
                      --output table

                    echo "âœ… Image ${{ service }}:$(imageTag) pushed successfully"

  - stage: Publish
    displayName: "Publish Build Info"
    dependsOn: Build
    jobs:
      - job: PublishArtifacts
        displayName: "Publish Build Artifacts"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: PublishBuildArtifacts@1
            displayName: "Publish Kubernetes Manifests"
            inputs:
              PathtoPublish: "kubernetes"
              ArtifactName: "kubernetes-manifests"
              publishLocation: "Container"

          - task: CopyFiles@2
            displayName: "Copy Build Info"
            inputs:
              Contents: |
                README.md
                RUNNING_WITH_FULL_STACK.md
              TargetFolder: "$(Build.ArtifactStagingDirectory)"

          - bash: |
              echo "Build Number: $(Build.BuildNumber)" > $(Build.ArtifactStagingDirectory)/build-info.txt
              echo "Image Tag: $(imageTag)" >> $(Build.ArtifactStagingDirectory)/build-info.txt
              echo "Environment: ${{ parameters.environment }}" >> $(Build.ArtifactStagingDirectory)/build-info.txt
              echo "Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $(Build.ArtifactStagingDirectory)/build-info.txt
            displayName: "Create Build Info"

          - task: PublishBuildArtifacts@1
            displayName: "Publish Build Info"
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)"
              ArtifactName: "drop"
              publishLocation: "Container"
