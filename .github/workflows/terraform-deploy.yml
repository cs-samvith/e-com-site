name: Terraform Infrastructure Deployment

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
    paths:
      - "infrastructure/terraform/**"
      - ".github/workflows/terraform-deploy.yml"

  # Trigger on pull requests
  pull_request:
    branches:
      - main
    paths:
      - "infrastructure/terraform/**"
      - ".github/workflows/terraform-deploy.yml"

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: "plan"

# Required permissions
permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  TERRAFORM_VERSION: "1.5.0"
  WORKING_DIRECTORY: "infrastructure/terraform"

jobs:
  # Job 1: Validate Terraform
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ${{ env.WORKING_DIRECTORY }}
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init -backend=false
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Comment on PR (if validation fails)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Validation Failed ‚ùå

            **Format Check:** \`${{ steps.fmt.outcome }}\`
            **Initialization:** \`${{ steps.init.outcome }}\`
            **Validation:** \`${{ steps.validate.outcome }}\`

            Please fix the issues and push again.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # Job 2: Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov (Terraform Security Scanner)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ env.WORKING_DIRECTORY }}
          framework: terraform
          output_format: sarif
          output_file_path: reports/checkov-results.sarif
          soft_fail: true

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: reports/checkov-results.sarif

      - name: Run tfsec (Terraform Security Scanner)
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ env.WORKING_DIRECTORY }}
          soft_fail: true

  # Job 3: Cost Estimation
  cost:
    name: Cost Estimation
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate Infracost JSON for Dev
        run: |
          terraform init -backend=false
          infracost breakdown --path . \
            --terraform-var-file=environments/dev.tfvars \
            --format json \
            --out-file /tmp/infracost-dev.json
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Post Infracost Comment
        uses: infracost/actions/comment@v1
        with:
          path: /tmp/infracost-dev.json
          behavior: update

  # Job 4: Plan - Development
  plan-dev:
    name: Plan (Dev)
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=ecommerce-dev.tfstate"
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file="environments/dev.tfvars" \
            -out=dev.tfplan \
            -no-color
        working-directory: ${{ env.WORKING_DIRECTORY }}
        continue-on-error: true

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-tfplan
          path: ${{ env.WORKING_DIRECTORY }}/dev.tfplan
          retention-days: 7

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Plan (Dev) üìù

            **Status:** \`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # Job 5: Plan - Staging
  plan-staging:
    name: Plan (Staging)
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=ecommerce-staging.tfstate"
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file="environments/staging.tfvars" \
            -out=staging.tfplan \
            -no-color
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: staging-tfplan
          path: ${{ env.WORKING_DIRECTORY }}/staging.tfplan
          retention-days: 7

  # Job 6: Plan - Production
  plan-prod:
    name: Plan (Production)
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment: prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=ecommerce-prod.tfstate"
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file="environments/prod.tfvars" \
            -out=prod.tfplan \
            -no-color
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: prod-tfplan
          path: ${{ env.WORKING_DIRECTORY }}/prod.tfplan
          retention-days: 7

  # Job 7: Apply - Development
  apply-dev:
    name: Apply (Dev)
    runs-on: ubuntu-latest
    needs: plan-dev
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev' && github.event.inputs.action == 'apply')
    environment:
      name: dev
      url: https://portal.azure.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=ecommerce-dev.tfstate"
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: dev-tfplan
          path: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve dev.tfplan
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Get Outputs
        id: output
        run: |
          echo "aks_cluster_name=$(terraform output -raw aks_cluster_name)" >> $GITHUB_OUTPUT
          echo "resource_group_name=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
          echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Create Deployment Summary
        run: |
          echo "## üöÄ Deployment Summary (Dev)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development" >> $GITHUB_STEP_SUMMARY
          echo "**AKS Cluster:** ${{ steps.output.outputs.aks_cluster_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ steps.output.outputs.resource_group_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ACR:** ${{ steps.output.outputs.acr_login_server }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Connect to cluster:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "az aks get-credentials --resource-group ${{ steps.output.outputs.resource_group_name }} --name ${{ steps.output.outputs.aks_cluster_name }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Job 8: Apply - Staging (with manual approval)
  apply-staging:
    name: Apply (Staging)
    runs-on: ubuntu-latest
    needs: plan-staging
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging' && github.event.inputs.action == 'apply')
    environment:
      name: staging
      url: https://portal.azure.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=ecommerce-staging.tfstate"
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: staging-tfplan
          path: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Apply
        run: terraform apply -auto-approve staging.tfplan
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Get Outputs
        id: output
        run: |
          echo "aks_cluster_name=$(terraform output -raw aks_cluster_name)" >> $GITHUB_OUTPUT
          echo "resource_group_name=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
        working-directory: ${{ env.WORKING_DIRECTORY }}

  # Job 9: Apply - Production (with manual approval)
  apply-prod:
    name: Apply (Production)
    runs-on: ubuntu-latest
    needs: plan-prod
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.environment == 'prod' && 
      github.event.inputs.action == 'apply'
    environment:
      name: prod
      url: https://portal.azure.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=ecommerce-prod.tfstate"
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: prod-tfplan
          path: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Apply
        run: terraform apply -auto-approve prod.tfplan
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Get Outputs
        id: output
        run: |
          echo "aks_cluster_name=$(terraform output -raw aks_cluster_name)" >> $GITHUB_OUTPUT
          echo "resource_group_name=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Create Deployment Summary
        run: |
          echo "## üöÄ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
          echo "**AKS Cluster:** ${{ steps.output.outputs.aks_cluster_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ steps.output.outputs.resource_group_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify Team
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ Production infrastructure deployed successfully!'
            })
