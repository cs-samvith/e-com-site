name: Deploy Monitoring Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy monitoring'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      stack:
        description: 'Monitoring stack to deploy'
        required: true
        type: choice
        options:
          - azure-native
          - prometheus-grafana
          - both
        default: 'both'

permissions:
  contents: read
  id-token: write

env:
  KUBECTL_VERSION: 'v1.28.0'

jobs:
  deploy-azure-monitoring:
    name: Deploy Azure Native Monitoring
    runs-on: ubuntu-latest
    if: github.event.inputs.stack == 'azure-native' || github.event.inputs.stack == 'both'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets[format('AZURE_CREDENTIALS_{0}', upper(github.event.inputs.environment))] }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=ecommerce-${{ github.event.inputs.environment }}.tfstate"
        working-directory: infrastructure/terraform

      - name: Terraform Plan (Monitoring Only)
        run: |
          terraform plan \
            -var-file="environments/${{ github.event.inputs.environment }}.tfvars" \
            -target=azurerm_application_insights.main \
            -target=azurerm_monitor_action_group.critical \
            -target=azurerm_monitor_action_group.warning \
            -target=azurerm_monitor_metric_alert.node_cpu \
            -target=azurerm_monitor_metric_alert.node_memory \
            -target=azurerm_monitor_metric_alert.node_not_ready \
            -target=azurerm_monitor_metric_alert.pod_failed \
            -out=monitoring.tfplan
        working-directory: infrastructure/terraform

      - name: Terraform Apply (Monitoring)
        run: terraform apply -auto-approve monitoring.tfplan
        working-directory: infrastructure/terraform

      - name: Get Application Insights Key
        id: app-insights
        run: |
          INSTRUMENTATION_KEY=$(terraform output -raw application_insights_instrumentation_key)
          echo "::add-mask::$INSTRUMENTATION_KEY"
          echo "instrumentation_key=$INSTRUMENTATION_KEY" >> $GITHUB_OUTPUT
        working-directory: infrastructure/terraform

      - name: Create Summary
        run: |
          echo "## âœ… Azure Monitoring Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Components:**" >> $GITHUB_STEP_SUMMARY
          echo "- Application Insights" >> $GITHUB_STEP_SUMMARY
          echo "- Action Groups (Critical & Warning)" >> $GITHUB_STEP_SUMMARY
          echo "- AKS Cluster Alerts" >> $GITHUB_STEP_SUMMARY
          echo "- Application Performance Alerts" >> $GITHUB_STEP_SUMMARY
          echo "- Cost Budget Alerts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure your applications to send telemetry to Application Insights" >> $GITHUB_STEP_SUMMARY
          echo "2. View metrics in Azure Portal" >> $GITHUB_STEP_SUMMARY
          echo "3. Create custom dashboards" >> $GITHUB_STEP_SUMMARY

  deploy-prometheus-stack:
    name: Deploy Prometheus & Grafana
    runs-on: ubuntu-latest
    if: github.event.inputs.stack == 'prometheus-grafana' || github.event.inputs.stack == 'both'
    environment: ${{ github.event.inputs.environment }}
    needs: deploy-azure-monitoring
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets[format('AZURE_CREDENTIALS_{0}', upper(github.event.inputs.environment))] }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Get AKS Credentials
        run: |
          RG_NAME="rg-ecommerce-aks-${{ github.event.inputs.environment }}"
          CLUSTER_NAME="aks-ecommerce-aks-${{ github.event.inputs.environment }}"
          
          az aks get-credentials \
            --resource-group $RG_NAME \
            --name $CLUSTER_NAME \
            --overwrite-existing

      - name: Create Monitoring Namespace
        run: |
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Prometheus Stack
        run: |
          kubectl apply -f kubernetes/monitoring/prometheus-stack.yaml
          
          echo "Waiting for Prometheus to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app=prometheus \
            -n monitoring \
            --timeout=300s
          
          echo "Waiting for Grafana to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app=grafana \
            -n monitoring \
            --timeout=300s

      - name: Get Grafana URL
        id: grafana
        run: |
          echo "Waiting for LoadBalancer IP..."
          sleep 30
          
          GRAFANA_IP=$(kubectl get svc grafana -n monitoring -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          
          if [ -z "$GRAFANA_IP" ]; then
            echo "Warning: LoadBalancer IP not yet assigned"
            GRAFANA_IP="pending"
          fi
          
          echo "grafana_url=http://$GRAFANA_IP" >> $GITHUB_OUTPUT

      - name: Get Prometheus URL
        id: prometheus
        run: |
          PROMETHEUS_POD=$(kubectl get pods -n monitoring -l app=prometheus -o jsonpath='{.items[0].metadata.name}')
          echo "prometheus_pod=$PROMETHEUS_POD" >> $GITHUB_OUTPUT

      - name: Verify Deployment
        run: |
          echo "=== Monitoring Stack Status ==="
          kubectl get all -n monitoring
          
          echo ""
          echo "=== Prometheus Status ==="
          kubectl get pods -n monitoring -l app=prometheus
          
          echo ""
          echo "=== Grafana Status ==="
          kubectl get pods -n monitoring -l app=grafana
          
          echo ""
          echo "=== AlertManager Status ==="
          kubectl get pods -n monitoring -l app=alertmanager

      - name: Create Summary
        run: |
          echo "## âœ… Prometheus & Grafana Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Access URLs:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Grafana Dashboard:**" >> $GITHUB_STEP_SUMMARY
          echo "- URL: \`${{ steps.grafana.outputs.grafana_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Username: \`admin\`" >> $GITHUB_STEP_SUMMARY
          echo "- Password: \`admin123\` (âš ï¸ Change immediately!)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Prometheus (Port Forward):**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n monitoring svc/prometheus 9090:9090" >> $GITHUB_STEP_SUMMARY
          echo "# Then access: http://localhost:9090" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**AlertManager (Port Forward):**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n monitoring svc/alertmanager 9093:9093" >> $GITHUB_STEP_SUMMARY
          echo "# Then access: http://localhost:9093" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Change Grafana password** immediately" >> $GITHUB_STEP_SUMMARY
          echo "2. Import dashboards from https://grafana.com/grafana/dashboards/" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure AlertManager with your notification channels" >> $GITHUB_STEP_SUMMARY
          echo "4. Add Prometheus scrape annotations to your services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Recommended Dashboards:" >> $GITHUB_STEP_SUMMARY
          echo "- Kubernetes Cluster Monitoring: Dashboard ID 7249" >> $GITHUB_STEP_SUMMARY
          echo "- Kubernetes Pod Monitoring: Dashboard ID 6417" >> $GITHUB_STEP_SUMMARY
          echo "- Node Exporter Full: Dashboard ID 1860" >> $GITHUB_STEP_SUMMARY

  configure-application-insights:
    name: Configure Application Insights in Services
    runs-on: ubuntu-latest
    needs: deploy-azure-monitoring
    if: always() && (github.event.inputs.stack == 'azure-native' || github.event.inputs.stack == 'both')
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets[format('AZURE_CREDENTIALS_{0}', upper(github.event.inputs.environment))] }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Get AKS Credentials
        run: |
          RG_NAME="rg-ecommerce-aks-${{ github.event.inputs.environment }}"
          CLUSTER_NAME="aks-ecommerce-aks-${{ github.event.inputs.environment }}"
          
          az aks get-credentials \
            --resource-group $RG_NAME \
            --name $CLUSTER_NAME \
            --overwrite-existing

      - name: Get Application Insights Connection String
        id: app-insights
        run: |
          RG_NAME="rg-ecommerce-aks-${{ github.event.inputs.environment }}"
          APPI_NAME="appi-ecommerce-aks-${{ github.event.inputs.environment }}"
          
          CONNECTION_STRING=$(az monitor app-insights component show \
            --resource-group $RG_NAME \
            --app $APPI_NAME \
            --query connectionString -o tsv)
          
          echo "::add-mask::$CONNECTION_STRING"
          echo "connection_string=$CONNECTION_STRING" >> $GITHUB_OUTPUT

      - name: Create/Update Application Insights Secret
        run: |
          kubectl create secret generic app-insights \
            --from-literal=connection-string="${{ steps.app-insights.outputs.connection_string }}" \
            --namespace=ecommerce \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Summary
        run: |
          echo "## âœ… Application Insights Configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Application Insights connection string has been stored as a Kubernetes secret." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### To use in your applications:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Python/FastAPI:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`python" >> $GITHUB_STEP_SUMMARY
          echo "from opencensus.ext.azure.log_exporter import AzureLogHandler" >> $GITHUB_STEP_SUMMARY
          echo "import logging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "connection_string = os.getenv('APPINSIGHTS_CONNECTION_STRING')" >> $GITHUB_STEP_SUMMARY
          echo "logger = logging.getLogger(__name__)" >> $GITHUB_STEP_SUMMARY
          echo "logger.addHandler(AzureLogHandler(connection_string=connection_string))" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Add to deployment YAML:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "env:" >> $GITHUB_STEP_SUMMARY
          echo "  - name: APPINSIGHTS_CONNECTION_STRING" >> $GITHUB_STEP_SUMMARY
          echo "    valueFrom:" >> $GITHUB_STEP_SUMMARY
          echo "      secretKeyRef:" >> $GITHUB_STEP_SUMMARY
          echo "        name: app-insights" >> $GITHUB_STEP_SUMMARY
          echo "        key: connection-string" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY